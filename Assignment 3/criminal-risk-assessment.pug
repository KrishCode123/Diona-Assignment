doctype html
html(lang="en")
  head
    title Criminal Risk Assessment Request
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(rel="stylesheet" href="styles.css")
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    script.
      function toggleForm() {
        const consentRadio = document.querySelector('input[name="consent"]:checked');
        const mainForm = document.getElementById('mainForm');
        
        if (consentRadio && consentRadio.value === 'yes') {
          mainForm.style.display = 'block';
        } else {
          mainForm.style.display = 'none';
          mainForm.reset();
        }
      }

      function validateDate(input) {
        const selectedDate = new Date(input.value);
        const today = new Date();
        if (selectedDate > today) {
          input.setCustomValidity('Future dates are not allowed');
          showError(input, 'Future dates are not allowed');
        } else {
          input.setCustomValidity('');
          hideError(input);
        }
      }

      function addPhoneInput() {
        const container = document.getElementById('phoneInputs');
        const newInput = document.createElement('div');
        newInput.className = 'phone-input-group';
        newInput.innerHTML = `
          <input type="tel" name="phone[]" placeholder="Enter phone number" required>
          <button type="button" class="remove-phone" onclick="this.parentElement.remove()">
            <i class="fas fa-minus"></i>
          </button>
        `;
        container.appendChild(newInput);
      }

      function showError(element, message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        element.parentNode.appendChild(errorDiv);
        element.classList.add('error');
      }

      function hideError(element) {
        const errorDiv = element.parentNode.querySelector('.error-message');
        if (errorDiv) {
          errorDiv.remove();
        }
        element.classList.remove('error');
      }

      function toggleOtherInput(checkbox) {
        const otherInput = document.getElementById('id_other_text');
        otherInput.style.display = checkbox.checked ? 'block' : 'none';
        if (!checkbox.checked) {
          otherInput.value = '';
        }
      }

      function validateForm() {
        const form = document.getElementById('mainForm');
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        const errorDiv = document.createElement('div');
        errorDiv.className = 'form-error';
        errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please fill in all required fields';
        
        // Remove any existing error message
        const existingError = form.querySelector('.form-error');
        if (existingError) {
          existingError.remove();
        }

        requiredFields.forEach(field => {
          if (!field.value.trim()) {
            isValid = false;
            field.classList.add('error');
          } else {
            field.classList.remove('error');
          }
        });

        if (!isValid) {
          form.insertBefore(errorDiv, form.firstChild);
          return false;
        }
        return true;
      }

      function printForm() {
        window.print();
      }
  body
    .container
      header
        h1 CRIMINAL RISK ASSESSMENT REQUEST
      
      // Consent Section
      .consent-section
        h2 Consent for Criminal Risk Assessment and Release of Information
        
        .consent-text
          p As a person who has, or may have, care, custody, control or charge of a child in receipt of services under The Child and Family Services Act, I authorize the Criminal Risk Assessment Unit of Manitoba Families' Child Protection Branch ("CRAU") to conduct enquiries of the Winnipeg Police Service (WPS), the RCMP and other law enforcement agencies necessary to assess the risk that l may endanger the life, health or emotional wellbeing of a child. I understand that this information is requested by (CFS Agency) for the purposes of, and in accordance with, s. 18.4(1.1) of The Child and Family Services Act, and may include a criminal record, criminal and Provincial Act convictions, orders or charges, other involvement/contact with law enforcement (including non-conviction information) or other information. I authorize the disclosure of said information to CRAU and an authorized Child and Family Services Agency designate or designates. I also authorize the disclosure of the personal identifying information set out below to CRAU, the WPS, RCMP and other law enforcement agencies for the purpose of completing a Criminal Risk Assessment. I understand that the results of this Criminal Risk Assessment are confidential, and may not be provided to me, but may be disclosed in accordance with s.76 of the Child and Family Services Act.
        
        .form-group
          .radio-group
            label
              input(type="radio" name="consent" value="yes" onchange="toggleForm()")
              | Yes, I consent
            label
              input(type="radio" name="consent" value="no" onchange="toggleForm()")
              | No, I do not consent

      // Main Form (hidden by default)
      form#mainForm(action="/submit" method="post" style="display:none;" onsubmit="return validateForm()")
        // Date Section
        section.date-section
          h2 Date Information
          
          .form-group
            label(for="date") Date:
            input(type="date" name="date" required onchange="validateDate(this)")
          
          .form-group
            label(for="signature") Signature of person being assessed:
            input(type="text" name="signature" required)
          
          .form-group
            label(for="witness_name") Witness Name (if consenting):
            input(type="text" name="witness_name")
          
          .form-group
            label(for="witness_signature") Witness Signature (if consenting):
            input(type="text" name="witness_signature")
          
          .form-group
            label.unconsented-label
              input(type="checkbox" name="unconsented" id="unconsentedCheckbox") 
              | Unconsented

        // Personal Information Section
        section.personal-info-section
          h2 Personal Information
          
          .form-group
            label(for="first_name") First Name:
            input(type="text" name="first_name" required)
          
          .form-group
            label(for="second_name") Middle Name (optional):
            input(type="text" name="second_name")
          
          .form-group
            label(for="last_name") Last Name:
            input(type="text" name="last_name" required)
          
          .form-group
            label(for="dob") Date of Birth:
            input(type="date" name="dob" required onchange="validateDate(this)")
          
          .form-group.gender-section
            label Gender:
            .radio-group
              label
                input(type="radio" name="gender" value="male" required) 
                | Male
              label
                input(type="radio" name="gender" value="female") 
                | Female

        // Contact Information Section
        section.contact-section
          h2 Contact Information
          
          .form-group
            label Phone Numbers:
            #phoneInputs
              .phone-input-group
                input(type="tel" name="phone[]" placeholder="Enter phone number" required)
                button(type="button" class="add-phone" onclick="addPhoneInput()")
                  i(class="fas fa-plus")
          
          .form-group
            label(for="address") Current Address:
            input(type="text" name="address" required)
          
          .form-group
            label(for="birthplace") City/Province or Country of Birth:
            input(type="text" name="birthplace" required)

        // Identification Section
        section.identification-section
          h2 Identification
          
          .form-group
            label Identification Provided (Select at least 2):
            .checkbox-group
              label
                input(type="checkbox" name="id_birth_certificate") 
                | Birth Certificate
              label
                input(type="checkbox" name="id_sin") 
                | Social Insurance Card
              label
                input(type="checkbox" name="id_health") 
                | Manitoba Health Card
              label
                input(type="checkbox" name="id_treaty") 
                | Treaty Card
              label
                input(type="checkbox" name="id_other" onchange="toggleOtherInput(this)") 
                | Other (specify)
              input(type="text" name="id_other_text" id="id_other_text" style="display:none;")
          
          .form-group
            label(for="dl_number") MB Driver's License Number:
            input(type="text" name="dl_number")

        // Agency Information Section
        section.agency-section
          h2 Agency Information
          
          .form-group
            label(for="agency_name") Name of Agency Submitting Request:
            input(type="text" name="agency_name" required)
          
          .form-group
            label(for="worker") Assigned Worker:
            input(type="text" name="worker" required)
          
          .form-group
            label(for="last_assessment") Date of Last Criminal Risk Assessment:
            input(type="date" name="last_assessment" onchange="validateDate(this)")
          
          .form-group
            label(for="designate") Submitting Designate:
            input(type="text" name="designate" required)
          
          .form-group
            label(for="designate_phone") Designate Phone #:
            input(type="tel" name="designate_phone" required)
          
          .form-group
            label(for="designate_email") Designate Email:
            input(type="email" name="designate_email" required)
          
          .form-group
            label(for="designate_fax") Designate Fax:
            input(type="text" name="designate_fax")
          
          .form-group
            label(for="request_date") Request Date:
            input(type="date" name="request_date" required onchange="validateDate(this)")

        // Assessment Reason Section
        section.reason-section
          h2 Reason for Risk Assessment
          
          .form-group
            .radio-group
              label
                input(type="radio" name="reason" value="Child Protection Concerns" required) 
                | Child Protection Concerns
              label
                input(type="radio" name="reason" value="Place of Safety") 
                | Place of Safety
              label
                input(type="radio" name="reason" value="Kinship Care") 
                | Kinship or Customary Care Agreement

        // Note Section
        .note-section
          p NOTE: The assessment completed by the Criminal Risk Assessment Unit of the Department of Families Child Protection Branch does not replace a criminal records check.

        .form-actions
          button(type="submit") Submit
          button(type="button" class="print-button" onclick="printForm()")
            i(class="fas fa-print")
            |  Print Form

    script.
      // Unconsented logic
      document.getElementById('unconsentedCheckbox').addEventListener('change', function() {
        const signatureInput = document.querySelector('input[name="signature"]');
        const nameInputs = document.querySelectorAll('input[name="first_name"], input[name="last_name"]');
        
        if (this.checked) {
          signatureInput.value = '';
          nameInputs.forEach(input => input.value = '');
          signatureInput.disabled = true;
          nameInputs.forEach(input => input.disabled = true);
        } else {
          signatureInput.disabled = false;
          nameInputs.forEach(input => input.disabled = false);
        }
      });

      // Validate at least 2 identification documents
      const form = document.getElementById('mainForm');
      form.addEventListener('submit', function(e) {
        const idCheckboxes = document.querySelectorAll('input[name^="id_"]:not([name="id_other_text"])');
        const checkedCount = Array.from(idCheckboxes).filter(cb => cb.checked).length;
        
        if (checkedCount < 2) {
          e.preventDefault();
          const errorDiv = document.createElement('div');
          errorDiv.className = 'alert alert-error';
          errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please select at least 2 forms of identification';
          document.querySelector('.identification-section').insertBefore(errorDiv, document.querySelector('.identification-section h2').nextSibling);
          setTimeout(() => errorDiv.remove(), 5000);
        }
      });

      // Phone number validation
      const phoneInputs = document.querySelectorAll('input[name="phone[]"]');
      phoneInputs.forEach(input => {
        input.addEventListener('input', function() {
          const phoneRegex = /^[\d\s,+-]+$/;
          if (!phoneRegex.test(this.value)) {
            this.setCustomValidity('Please enter valid phone numbers separated by commas');
          } else {
            this.setCustomValidity('');
          }
        });
      });

      // Email validation
      const emailInput = document.querySelector('input[name="designate_email"]');
      emailInput.addEventListener('input', function() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(this.value)) {
          this.setCustomValidity('Please enter a valid email address');
        } else {
          this.setCustomValidity('');
        }
      }); 